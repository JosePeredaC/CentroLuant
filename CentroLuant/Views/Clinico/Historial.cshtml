@model CentroLuant.Models.HistorialViewModel

@{
    ViewData["Title"] = "Historial clínico";
}

<style>
    .panel-wrapper {
        max-width: 1100px;
        margin: 0 auto;
        padding: 24px 20px 40px;
    }

    .search-card,
    .info-card {
        background: #ffffff;
        border-radius: 16px;
        border: 1px solid #E2E8F0;
        box-shadow: 0 10px 28px rgba(15,23,42,0.08);
        padding: 20px 22px;
        margin-bottom: 18px;
    }

    .section-title-main {
        font-size: 1.5rem;
        font-weight: 700;
        color: #0F172A;
        margin-bottom: 4px;
    }

    .section-subtitle {
        color: #64748B;
        font-size: .9rem;
    }

    .pill {
        padding: 3px 10px;
        border-radius: 999px;
        font-size: .75rem;
        background: #DBEAFE;
        color: #1D4ED8;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: .06em;
    }

    .form-label {
        font-size: .9rem;
        font-weight: 500;
    }

    .form-control {
        border-radius: 10px;
        border-color: #E2E8F0;
    }

    .table thead th {
        background: #F8FAFC;
        border-bottom: 1px solid #E2E8F0;
        font-size: .85rem;
        color: #475569;
    }

    .table tbody td {
        font-size: .85rem;
        vertical-align: middle;
    }

    .small-muted {
        font-size: .8rem;
        color: #94A3B8;
    }
</style>

<div class="panel-wrapper">
    <div class="mb-2">
        <h2 class="section-title-main">Historial clínico</h2>
        <p class="section-subtitle">
            Busque un paciente por DNI para revisar sus atenciones y registrar nuevos tratamientos.
        </p>
    </div>

    <!-- BUSCADOR -->
    <div class="search-card">
        <form asp-action="Historial" method="get" class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label">DNI del paciente</label>
                <input type="text"
                       name="dni"
                       maxlength="8"
                       class="form-control"
                       value="@Context.Request.Query["dni"]" />
                <div class="small-muted mt-1">
                    Ingrese el DNI y presione <strong>Buscar</strong>.
                </div>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary mt-1">
                    Buscar
                </button>
            </div>
        </form>

        @if (ViewBag.Error != null)
        {
            <div class="alert alert-danger mt-3 mb-0">
                @ViewBag.Error
            </div>
        }
        @if (ViewBag.Msg != null)
        {
            <div class="alert alert-success mt-3 mb-0">
                @ViewBag.Msg
            </div>
        }
        @if (ViewBag.MsgError != null)
        {
            <div class="alert alert-warning mt-3 mb-0">
                @ViewBag.MsgError
            </div>
        }
    </div>

    @if (Model.Paciente != null && Model.Historial != null)
    {
        <!-- INFO PACIENTE + HISTORIAL -->
        <div class="info-card">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <div class="pill mb-2">Paciente</div>
                    <h5 class="mb-1">
                        @Model.Paciente.Nombres @Model.Paciente.Apellidos
                    </h5>
                    <div class="small-muted">
                        DNI: @Model.Paciente.DNI ·
                        Nacimiento: @(Model.Paciente.FechaNacimiento?.ToString("dd/MM/yyyy") ?? "-")
                    </div>
                    <div class="small-muted">
                        Tel: @Model.Paciente.Telefono ?? "-" ·
                        Correo: @Model.Paciente.CorreoElectronico ?? "-"
                    </div>
                </div>

                <div class="text-end">
                    <div class="small-muted">
                        Historial N.º @Model.Historial.ID_Historial<br />
                        Creado: @Model.Historial.FechaCreacion.ToString("dd/MM/yyyy")
                    </div>

                    <!-- 🔹 BOTÓN EDITAR HISTORIAL -->
                    <a asp-action="EditarHistorial"
                       asp-route-idHistorial="@Model.Historial.ID_Historial"
                       class="btn btn-sm btn-outline-primary mt-2">
                        Editar historial
                    </a>
                </div>
            </div>

            <hr />

            <div class="row g-4 mt-2">
                <div class="col-lg-7">
                    <h6 class="mb-2">Tratamientos registrados</h6>

                    @if (Model.Tratamientos == null || !Model.Tratamientos.Any())
                    {
                        <div class="small-muted">
                            No hay tratamientos registrados para este historial.
                        </div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-sm align-middle mb-0">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Tipo</th>
                                        <th>Diagnóstico</th>
                                        <th class="text-end">Costo</th>
                                        <th class="text-end">Acciones</th> @* NUEVA COLUMNA *@
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var t in Model.Tratamientos)
                                    {
                                        <tr>
                                            <td>@t.FechaTratamiento.ToString("dd/MM/yyyy")</td>
                                            <td>@t.TipoTratamiento</td>
                                            <td>@t.Diagnostico</td>
                                            <td class="text-end">S/ @t.Costo.ToString("0.00")</td>
                                            <td class="text-end">
                                                <!-- 🔹 BOTÓN EDITAR TRATAMIENTO -->
                                                <a asp-action="EditarTratamiento"
                                                   asp-route-id="@t.ID_Tratamiento"
                                                   class="btn btn-sm btn-outline-secondary">
                                                    Editar
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>

                <div class="col-lg-5">
                    <h6 class="mb-2">Registrar nuevo tratamiento</h6>

                    <form asp-action="RegistrarTratamiento" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="ID_Historial" value="@Model.Historial.ID_Historial" />
                        <input type="hidden" name="DNI_Paciente" value="@Model.Paciente.DNI" />

                        <div class="mb-2">
                            <label class="form-label">Fecha</label>
                            <input type="date" name="FechaTratamiento"
                                   value="@DateTime.Today.ToString("yyyy-MM-dd")"
                                   class="form-control" />
                        </div>

                        <div class="mb-2">
                            <label class="form-label">Tipo de tratamiento</label>
                            <input type="text" name="TipoTratamiento" class="form-control"
                                   placeholder="Ej. Endodoncia, Profilaxis" />
                        </div>

                        <div class="mb-2">
                            <label class="form-label">Diagnóstico</label>
                            <input type="text" name="Diagnostico" class="form-control"
                                   placeholder="Diagnóstico resumido" />
                        </div>

                        <div class="mb-2">
                            <label class="form-label">Observaciones</label>
                            <textarea name="Observaciones" rows="3" class="form-control"
                                  placeholder="Notas clínicas relevantes"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Costo (S/)</label>
                            <input type="number" step="0.01" min="0"
                                   name="Costo" class="form-control" value="0.00" />
                        </div>

                        <button type="submit" class="btn btn-primary w-100">
                            Guardar tratamiento
                        </button>
                    </form>
                </div>
            </div>
        </div>
    }
</div>
